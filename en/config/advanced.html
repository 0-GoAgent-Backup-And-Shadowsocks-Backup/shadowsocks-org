<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><title>Shadowsocks - Advanced</title><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content=""><meta name="author" content=""><link rel="stylesheet" href="/assets/css/app.css"><!--[if lt IE 9]><script src="/assets/js/html5.js"></script><![endif]--><link rel="shortcut icon" href="/assets/img/favicon/favicon.ico"><link rel="apple-touch-icon" href="/assets/img/favicon/apple-touch-icon.png"><link rel="apple-touch-icon" sizes="72x72" href="/assets/img/favicon/apple-touch-icon-72x72.png"><link rel="apple-touch-icon" sizes="114x114" href="/assets/img/favicon/apple-touch-icon-114x114.png"></head><body><div id="wrap" class="boxed"><header><div class="container clearfix"><div class="eight columns"><div class="logo"><a href="/en/index.html">shadowsocks</a></div></div><div class="eight columns"><nav id="menu" class="navigation"><ul id="nav"><li><a href="javascript:void" class="">download</a><ul><li><a href="/en/download/clients.html">Clients</a></li><li><a href="/en/download/servers.html">Servers</a></li></ul></li><li><a href="javascript:void" class="active">config</a><ul><li><a href="/en/config/quick-guide.html">Quick Guide</a></li><li><a href="/en/config/advanced.html">Advanced</a></li></ul></li><li><a href="javascript:void" class="">about</a><ul><li><a href="/en/about/contributors.html">Contributors</a></li></ul></li><li><a href="javascript:void">en</a><ul><li><a href="/en/index.html">en</a></li></ul></li></ul></nav></div><div class="sixteen columns"><hr></div></div></header><div class="container clearfix"><div class="sixteen columns"><h1 class="page-title">Advanced<a href="https://github.com/madeye/shadowsocks-org/edit/master/docs/config/02-advanced.md" data-tooltip="Edit this page on GitHub" class="edit"><i class="icon-edit"></i></a><span class="line"></span></h1></div><div class="page-columns"><div id="markdown" class="sixteen columns bottom"><h2>Optimize the shadowsocks server on Linux</h2><p>This article is originally posted on <a href="https://maxlv.net/optimize-a-shadowsocks-server/">Lv. MAX</a>.</p><p>First of all, upgrade your Linux kerenl to 3.5 or later.</p><h3>Step 1, increase the maximum number of open file descriptors</h3><p>To handle thousands of concurrent TCP connections, we should increase the limit of open file descriptors.</p><p>Edit the <code>limits.conf</code></p><pre><code class="language-bash">vi /etc/security/limits.conf</code></pre><p>Add these two lines</p><pre><code><span class="hljs-bullet">* </span>soft nofile 51200
<span class="hljs-bullet">* </span>hard nofile 51200</code></pre><p>Then, before you start the shadowsocks server, make sure to set the ulimit first</p><pre><code class="language-bash">ulimit -n <span class="hljs-number">51200</span></code></pre><h3>Step 2, Optimize the kernel parameters</h3><p>There are several kernel parameters needed to be tuned for shadowsocks. The priciples are</p><ol><li>Reuse ports and conections as soon as possible.</li><li>Enlarge the queues and buffers as large as possible.</li><li>Choose the TCP congestion algorithm for large latency and high throughput.</li></ol><p>Here is an example <code>/etc/sysctl.conf</code> of our production servers:</p><pre><code>net<span class="hljs-preprocessor">.core</span><span class="hljs-preprocessor">.wmem</span>_max = <span class="hljs-number">12582912</span>
net<span class="hljs-preprocessor">.core</span><span class="hljs-preprocessor">.rmem</span>_max = <span class="hljs-number">12582912</span>
net<span class="hljs-preprocessor">.ipv</span>4<span class="hljs-preprocessor">.tcp</span>_rmem = <span class="hljs-number">10240</span> <span class="hljs-number">87380</span> <span class="hljs-number">12582912</span>
net<span class="hljs-preprocessor">.ipv</span>4<span class="hljs-preprocessor">.tcp</span>_wmem = <span class="hljs-number">10240</span> <span class="hljs-number">87380</span> <span class="hljs-number">12582912</span>
net<span class="hljs-preprocessor">.ipv</span>4<span class="hljs-preprocessor">.ip</span>_local_port_range = <span class="hljs-number">18000</span>    <span class="hljs-number">65535</span>
net<span class="hljs-preprocessor">.ipv</span>4<span class="hljs-preprocessor">.netfilter</span><span class="hljs-preprocessor">.ip</span>_conntrack_tcp_timeout_time_wait = <span class="hljs-number">1</span>
net<span class="hljs-preprocessor">.ipv</span>4<span class="hljs-preprocessor">.tcp</span>_window_scaling = <span class="hljs-number">1</span>
net<span class="hljs-preprocessor">.ipv</span>4<span class="hljs-preprocessor">.tcp</span>_max_syn_backlog = <span class="hljs-number">3240000</span>
net<span class="hljs-preprocessor">.core</span><span class="hljs-preprocessor">.somaxconn</span> = <span class="hljs-number">3240000</span>
net<span class="hljs-preprocessor">.ipv</span>4<span class="hljs-preprocessor">.tcp</span>_max_tw_buckets = <span class="hljs-number">1440000</span>
net<span class="hljs-preprocessor">.ipv</span>4<span class="hljs-preprocessor">.tcp</span>_congestion_control = hybla
net<span class="hljs-preprocessor">.ipv</span>4<span class="hljs-preprocessor">.tcp</span>_tw_reuse = <span class="hljs-number">1</span>
net<span class="hljs-preprocessor">.ipv</span>4<span class="hljs-preprocessor">.tcp</span>_fin_timeout = <span class="hljs-number">15</span>
net<span class="hljs-preprocessor">.ipv</span>4<span class="hljs-preprocessor">.tcp</span>_syn_retries = <span class="hljs-number">2</span>
net<span class="hljs-preprocessor">.ipv</span>4<span class="hljs-preprocessor">.tcp</span>_synack_retries = <span class="hljs-number">2</span>
net<span class="hljs-preprocessor">.ipv</span>4<span class="hljs-preprocessor">.tcp</span>_tw_recycle = <span class="hljs-number">1</span></code></pre><p>Of course, remember to execute <code>sysctl -p</code> to reload the config at runtime.</p><h3>How to verify your optimizations work</h3><p>Use munin or any server monitor tools to generate the graph of your TCP connections. A well tuned server should look like this</p><p><img src="http://ww4.sinaimg.cn/large/61b416b1gw1e9jmyps9vpj20dt0b4wg7.jpg" alt="one month munin TCP graph" width="" height=""></p></div></div></div><div class="push"></div></div><footer><div class="container"><div class="sisteen columns"><span class="copyright"><a href="https://github.com/shadowsocks">Shadowsocks</a>&nbsp;is released under the <a href="https://github.com/madeye/shadowsocks-libev/blob/master/LICENSE">GPLv3 license</a>&nbsp; or the <a href="https://github.com/clowwindy/shadowsocks/blob/master/LICENSE">MIT license</a>. Site by <a href="https://github.com/madeye">Max Lv</a>. Theme by <a href="http://karma-runner.github.io">Karma</a>.</span></div></div></footer></body><script src="/assets/js/app.js"></script><script src="/assets/js/analytics.js"></script></html>